import os
from docx import Document
from docx.text.paragraph import Paragraph
from docx.table import Table
from docx.oxml.text.paragraph import CT_P
from docx.oxml.table import CT_Tbl
from docx.shared import Inches, Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH

def create_sample_docx(filename="sample_document.docx"):
    """
    Creates a sample .docx file with mixed paragraphs and tables for testing.
    """
    print(f"Creating sample file: {filename}...")
    
    # Create a new document
    doc = Document()

    # Add a title
    doc.add_heading("Document with Mixed Content", level=0)

    # Add a paragraph
    doc.add_paragraph(
        "This is the first paragraph. It appears before any tables. "
        "We want to extract this text first."
    )

    # Add a simple 2x2 table
    doc.add_heading("First Table", level=2)
    table1 = doc.add_table(rows=2, cols=2)
    table1.style = 'Table Grid'
    # Header row
    table1.cell(0, 0).text = "Header 1"
    table1.cell(0, 1).text = "Header 2"
    # Data row
    table1.cell(1, 0).text = "Cell (1,0)"
    table1.cell(1, 1).text = "Cell (1,1)"

    # Add another paragraph
    doc.add_paragraph(
        "This second paragraph is located between the two tables. "
        "Its sequence (after the first table and before the second) is important."
    )

    # Add a more complex 3x3 table
    doc.add_heading("Second Table", level=2)
    table2 = doc.add_table(rows=3, cols=3)
    table2.style = 'Table Grid'
    for i in range(3):
        for j in range(3):
            table2.cell(i, j).text = f"Row {i+1}, Col {j+1}"

    # Add a final paragraph
    doc.add_paragraph("This is the final paragraph, appearing after all other content.")

    # Save the document
    doc.save(filename)
    print("Sample file created successfully.")

def extract_docx_content(filepath):
    """
    Extracts paragraphs and tables from a .docx file in sequential order.
    
    Args:
        filepath (str): The path to the .docx file.

    Returns:
        list: A list of tuples, where each tuple contains:
              ("paragraph", text) or ("table", list_of_lists_of_cell_text)
    """
    
    # Open the .docx file
    doc = Document(filepath)
    
    full_content = []

    # Iterate through the main body of the document
    # doc._body.inner_content_elements gives us a mix of paragraphs (CT_P)
    # and tables (CT_Tbl) in the order they appear.
    for element in doc._body.inner_content_elements:
        
        # Check if the element is a paragraph
        if isinstance(element, CT_P):
            # Re-hydrate the element into a full Paragraph object
            paragraph = Paragraph(element, doc)
            if paragraph.text.strip():  # Avoid empty paragraphs
                full_content.append(("paragraph", paragraph.text))
        
        # Check if the element is a table
        elif isinstance(element, CT_Tbl):
            # Re-hydrate the element into a full Table object
            table = Table(element, doc)
            
            # Extract data from the table
            table_data = []
            for row in table.rows:
                row_data = []
                for cell in row.cells:
                    row_data.append(cell.text)
                table_data.append(row_data)
                
            full_content.append(("table", table_data))
            
    return full_content

def main():
    """
    Main function to run the demonstration.
    """
    sample_filename = "sample_document.docx"
    
    try:
        # 1. Create the sample document
        create_sample_docx(sample_filename)
        
        print("\n" + "="*30)
        print("Extracting Content in Sequence...")
        print("="*30 + "\n")
        
        # 2. Extract the content
        content = extract_docx_content(sample_filename)
        
        # 3. Print the extracted content in order
        for item_type, item_data in content:
            if item_type == "paragraph":
                print(f"[PARAGRAPH]")
                print(item_data)
            
            elif item_type == "table":
                print(f"[TABLE]")
                for row in item_data:
                    # Format table rows for clearer printing
                    print("  | " + " | ".join(cell.ljust(15) for cell in row) + " |")
            
            print("...\n")

    except Exception as e:
        print(f"An error occurred: {e}")
    
    finally:
        # 4. Clean up the sample file
        if os.path.exists(sample_filename):
            os.remove(sample_filename)
            print(f"\nCleaned up sample file: {sample_filename}")

if __name__ == "__main__":
    main()

