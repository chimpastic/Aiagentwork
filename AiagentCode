import os
import sys
import json
import boto3
import urllib3 # Added for warning suppression
from pathlib import Path
from typing import List, Dict, Any

# ==========================================
# IMPORTS
# ==========================================
try:
    from langchain_core.tools import tool
    from langchain_core.messages import HumanMessage, AIMessage, ToolMessage, SystemMessage, BaseMessage
    from langchain_aws import ChatBedrock
    from dotenv import load_dotenv
    load_dotenv()
except ImportError as e:
    print(f"Import Error: {e}")
    sys.exit(1)

# ==========================================
# CONFIGURATION
# ==========================================
WORKSPACE_DIR = Path(os.getcwd()) / "agent_workspace"
if not WORKSPACE_DIR.exists():
    os.makedirs(WORKSPACE_DIR)

def validate_path(file_path: str) -> Path:
    target_path = (WORKSPACE_DIR / file_path).resolve()
    if WORKSPACE_DIR.resolve() not in target_path.parents and WORKSPACE_DIR.resolve() != target_path:
        raise ValueError("Access denied: Path is outside the sandbox.")
    return target_path

# ==========================================
# 1. YOUR CUSTOM CLIENT FUNCTION
# ==========================================
def initialize_bedrock_client():
    """
    Put your specific connection logic here (from your screenshot).
    """
    region = os.environ.get("AWS_DEFAULT_REGION", "us-east-1")
    
    print(f"Initializing custom Bedrock client in {region}...")
    
    # --- ADDED: DISABLE SSL VERIFICATION ---
    # Suppress the "InsecureRequestWarning" that appears when verify=False
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    
    client = boto3.client(
        "bedrock-runtime", 
        region_name=region,
        verify=False  # <--- THIS DISABLES SSL CHECKING
    )
    return client

# ==========================================
# TOOLS
# ==========================================
@tool
def list_directory(sub_path: str = ".") -> str:
    """List all files and folders in the current directory."""
    try:
        safe_path = validate_path(sub_path)
        if not safe_path.exists(): return "Directory does not exist."
        items = os.listdir(safe_path)
        if not items: return "Directory is empty."
        return "\n".join([f"[{'DIR' if (safe_path/i).is_dir() else 'FILE'}] {i}" for i in items])
    except Exception as e: return f"Error: {e}"

@tool
def create_directory(directory_name: str) -> str:
    """Create a new directory."""
    try:
        safe_path = validate_path(directory_name)
        os.makedirs(safe_path, exist_ok=True)
        return f"Created directory: {directory_name}"
    except Exception as e: return f"Error: {e}"

@tool
def write_file(file_path: str, content: str) -> str:
    """Write content to a file."""
    try:
        safe_path = validate_path(file_path)
        if not safe_path.parent.exists(): return "Error: Parent directory missing."
        with open(safe_path, "w", encoding="utf-8") as f:
            f.write(content)
        return f"Successfully wrote to {file_path}"
    except Exception as e: return f"Error: {e}"

@tool
def read_file(file_path: str) -> str:
    """Read the contents of a file."""
    try:
        safe_path = validate_path(file_path)
        if not safe_path.exists(): return "Error: File does not exist."
        with open(safe_path, "r", encoding="utf-8") as f:
            return f.read()
    except Exception as e: return f"Error: {e}"

# ==========================================
# AGENT LOOP
# ==========================================
def simple_agent_loop(llm_with_tools, user_input: str, chat_history: List[BaseMessage], tools_map: Dict):
    print("  Thinking...", end="\r")
    current_messages = list(chat_history) + [HumanMessage(content=user_input)]
    
    for _ in range(5): # Max 5 turns
        try:
            response = llm_with_tools.invoke(current_messages)
        except Exception as e:
            return f"API Error: {e}", current_messages

        current_messages.append(response)
        
        if response.tool_calls:
            print(f"  > Tools: {[t['name'] for t in response.tool_calls]}")
            for tool_call in response.tool_calls:
                if tool_call['name'] in tools_map:
                    res = tools_map[tool_call['name']].invoke(tool_call['args'])
                    current_messages.append(ToolMessage(content=str(res), tool_call_id=tool_call['id'], name=tool_call['name']))
                else:
                    current_messages.append(ToolMessage(content="Tool not found", tool_call_id=tool_call['id'], name=tool_call['name']))
        else:
            return response.content, current_messages

    return "Limit reached.", current_messages

# ==========================================
# MAIN
# ==========================================
def run_agent():
    try:
        # 1. Use YOUR custom client
        custom_client = initialize_bedrock_client()
        
        # 2. Inject it into LangChain
        llm = ChatBedrock(
            client=custom_client,  # <--- THIS CONNECTS YOUR LOGIC TO LANGCHAIN
            model_id="anthropic.claude-3-5-sonnet-20240620-v1:0",
            model_kwargs={"temperature": 0}
        )

        # 3. Setup Tools
        tools = [list_directory, create_directory, write_file, read_file]
        tools_map = {t.name: t for t in tools}
        llm_with_tools = llm.bind_tools(tools)

        chat_history = [SystemMessage(content="You are a file system agent. You operate in a sandbox.")]
        
        print(f"--- AI Agent Started ---")
        while True:
            user_input = input("\nUser: ")
            if user_input.lower() in ["exit", "quit"]: break
            
            ans, chat_history = simple_agent_loop(llm_with_tools, user_input, chat_history, tools_map)
            print(f"Agent: {ans}")

    except Exception as e:
        print(f"Startup Error: {e}")

if __name__ == "__main__":
    run_agent()


